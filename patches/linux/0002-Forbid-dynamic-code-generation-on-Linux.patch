From 513eb1494c68b26868dff9d7f02d1aa61c4c99d3 Mon Sep 17 00:00:00 2001
From: qua3k <qua3kr@gmail.com>
Date: Thu, 4 Nov 2021 00:00:00 +0000
Subject: [PATCH] Forbid dynamic code generation on Linux

The Windows sandbox prevents dynamic code generation via setting
MITIGATION_DYNAMIC_CODE_DISABLE on certain processes; prevent dynamic
code generation in the same processes on Linux via seccomp-bpf.
---
 .../seccomp-bpf-helpers/baseline_policy.cc    |  6 +--
 .../policy/linux/bpf_audio_policy_linux.cc    |  3 ++
 .../policy/linux/bpf_renderer_policy_linux.cc | 21 +++++++-
 .../policy/linux/bpf_renderer_policy_linux.h  |  5 +-
 .../policy/linux/bpf_service_policy_linux.cc  | 21 ++++++++
 .../policy/linux/bpf_service_policy_linux.h   |  5 +-
 .../policy/linux/sandbox_seccomp_bpf_linux.cc | 49 +++++++++++++++++--
 7 files changed, 99 insertions(+), 11 deletions(-)

diff --git a/sandbox/linux/seccomp-bpf-helpers/baseline_policy.cc b/sandbox/linux/seccomp-bpf-helpers/baseline_policy.cc
index d84e33999f161..91ab235e6383d 100644
--- a/sandbox/linux/seccomp-bpf-helpers/baseline_policy.cc
+++ b/sandbox/linux/seccomp-bpf-helpers/baseline_policy.cc
@@ -258,19 +258,19 @@ ResultExpr EvaluateSyscallImpl(int fs_denied_errno,
 #if defined(__i386__) || defined(__x86_64__) || defined(__mips__) || \
     defined(__aarch64__)
   if (sysno == __NR_mmap)
-    return RestrictMmapFlags();
+    return RestrictMmapFlagsNoWX();
 #endif
 
 #if defined(__i386__) || defined(__arm__) || \
     (defined(ARCH_CPU_MIPS_FAMILY) && defined(ARCH_CPU_32_BITS))
   if (sysno == __NR_mmap2)
-    return RestrictMmapFlags();
+    return RestrictMmapFlagsNoWX();
 #endif
 
   if (sysno == __NR_mprotect || sysno == __NR_pkey_mprotect) {
     // pkey_mprotect is identical to mprotect except for the additional (last)
     // parameter, which can be ignored here.
-    return RestrictMprotectFlags();
+    return RestrictMprotectFlagsNoWX();
   }
 
   if (sysno == __NR_prctl)
diff --git a/sandbox/policy/linux/bpf_audio_policy_linux.cc b/sandbox/policy/linux/bpf_audio_policy_linux.cc
index bb6424cf83d00..1d1ae13a695c4 100644
--- a/sandbox/policy/linux/bpf_audio_policy_linux.cc
+++ b/sandbox/policy/linux/bpf_audio_policy_linux.cc
@@ -118,6 +118,9 @@ ResultExpr AudioProcessPolicy::EvaluateSyscall(int system_call_number) const {
 #endif
     default:
 #if defined(__x86_64__)
+      if (system_call_number == __NR_shmat)
+        return RestrictShmatFlags();
+
       if (SyscallSets::IsSystemVSemaphores(system_call_number) ||
           SyscallSets::IsSystemVSharedMemory(system_call_number)) {
         return Allow();
diff --git a/sandbox/policy/linux/bpf_renderer_policy_linux.cc b/sandbox/policy/linux/bpf_renderer_policy_linux.cc
index 5e4483a1019db..08d8574e2d7c7 100644
--- a/sandbox/policy/linux/bpf_renderer_policy_linux.cc
+++ b/sandbox/policy/linux/bpf_renderer_policy_linux.cc
@@ -48,10 +48,29 @@ ResultExpr RestrictIoctl() {
 
 }  // namespace
 
-RendererProcessPolicy::RendererProcessPolicy() {}
+RendererProcessPolicy::RendererProcessPolicy(bool is_jit_disabled)
+    : is_jit_disabled_(is_jit_disabled) {}
 RendererProcessPolicy::~RendererProcessPolicy() {}
 
 ResultExpr RendererProcessPolicy::EvaluateSyscall(int sysno) const {
+
+  if (!is_jit_disabled_) {
+    switch (sysno) {
+#if defined(__i386__) || defined(__x86_64__) || defined(__mips__) || \
+    defined(__aarch64__)
+      case __NR_mmap:
+#endif
+#if defined(__i386__) || defined(__arm__) || \
+    (defined(ARCH_CPU_MIPS_FAMILY) && defined(ARCH_CPU_32_BITS))
+      case __NR_mmap2:
+#endif
+        return RestrictMmapFlags();
+      case __NR_mprotect:
+      case __NR_pkey_mprotect:
+        return RestrictMprotectFlags();
+    }
+  }
+
   switch (sysno) {
     // The baseline policy allows __NR_clock_gettime. Allow
     // clock_getres() for V8. crbug.com/329053.
diff --git a/sandbox/policy/linux/bpf_renderer_policy_linux.h b/sandbox/policy/linux/bpf_renderer_policy_linux.h
index 6d8b255b49881..c06055db7ef0e 100644
--- a/sandbox/policy/linux/bpf_renderer_policy_linux.h
+++ b/sandbox/policy/linux/bpf_renderer_policy_linux.h
@@ -13,7 +13,7 @@ namespace policy {
 // This policy can be used by both renderer and worker processes.
 class RendererProcessPolicy : public BPFBasePolicy {
  public:
-  RendererProcessPolicy();
+  explicit RendererProcessPolicy(bool is_jit_disabled);
 
   RendererProcessPolicy(const RendererProcessPolicy&) = delete;
   RendererProcessPolicy& operator=(const RendererProcessPolicy&) = delete;
@@ -21,6 +21,9 @@ class RendererProcessPolicy : public BPFBasePolicy {
   ~RendererProcessPolicy() override;
 
   bpf_dsl::ResultExpr EvaluateSyscall(int system_call_number) const override;
+
+ private:
+  const bool is_jit_disabled_;  // Disable dynamic code generation if jitless
 };
 
 }  // namespace policy
diff --git a/sandbox/policy/linux/bpf_service_policy_linux.cc b/sandbox/policy/linux/bpf_service_policy_linux.cc
index 32754e67be3d6..aff36f0119ee2 100644
--- a/sandbox/policy/linux/bpf_service_policy_linux.cc
+++ b/sandbox/policy/linux/bpf_service_policy_linux.cc
@@ -20,7 +20,28 @@ using sandbox::bpf_dsl::ResultExpr;
 namespace sandbox {
 namespace policy {
 
+ServiceProcessPolicy::ServiceProcessPolicy(bool is_jit_disabled)
+    : is_jit_disabled_(is_jit_disabled) {}
+
 ResultExpr ServiceProcessPolicy::EvaluateSyscall(int sysno) const {
+
+  if (!is_jit_disabled_) {
+    switch (sysno) {
+#if defined(__i386__) || defined(__x86_64__) || defined(__mips__) || \
+    defined(__aarch64__)
+      case __NR_mmap:
+#endif
+#if defined(__i386__) || defined(__arm__) || \
+    (defined(ARCH_CPU_MIPS_FAMILY) && defined(ARCH_CPU_32_BITS))
+      case __NR_mmap2:
+#endif
+        return RestrictMmapFlags();
+      case __NR_mprotect:
+      case __NR_pkey_mprotect:
+        return RestrictMprotectFlags();
+    }
+  }
+
   switch (sysno) {
     case __NR_ioctl:
       return RestrictIoctl();
diff --git a/sandbox/policy/linux/bpf_service_policy_linux.h b/sandbox/policy/linux/bpf_service_policy_linux.h
index 0f33163d6a87f..48626cb8111fa 100644
--- a/sandbox/policy/linux/bpf_service_policy_linux.h
+++ b/sandbox/policy/linux/bpf_service_policy_linux.h
@@ -16,13 +16,16 @@ namespace policy {
 // Consider UtilityProcessPolicy if this is too restrictive.
 class ServiceProcessPolicy : public BPFBasePolicy {
  public:
-  ServiceProcessPolicy() = default;
+  explicit ServiceProcessPolicy(bool is_jit_disabled);
   ~ServiceProcessPolicy() override = default;
 
   bpf_dsl::ResultExpr EvaluateSyscall(int system_call_number) const override;
 
   ServiceProcessPolicy(const ServiceProcessPolicy&) = delete;
   ServiceProcessPolicy& operator=(const ServiceProcessPolicy&) = delete;
+
+ private:
+  const bool is_jit_disabled_;  // Disable dynamic code generation if jitless
 };
 
 }  // namespace policy
diff --git a/sandbox/policy/linux/sandbox_seccomp_bpf_linux.cc b/sandbox/policy/linux/sandbox_seccomp_bpf_linux.cc
index 8ff750b32b966..d79024b792e35 100644
--- a/sandbox/policy/linux/sandbox_seccomp_bpf_linux.cc
+++ b/sandbox/policy/linux/sandbox_seccomp_bpf_linux.cc
@@ -30,6 +30,8 @@
 
 #include "base/files/scoped_file.h"
 #include "base/posix/eintr_wrapper.h"
+#include "base/strings/string_split.h"
+#include "gin/gin_features.h"
 #include "sandbox/linux/seccomp-bpf-helpers/baseline_policy.h"
 #include "sandbox/linux/seccomp-bpf-helpers/sigsys_handlers.h"
 #include "sandbox/linux/seccomp-bpf-helpers/syscall_parameters_restrictions.h"
@@ -51,6 +53,7 @@
 #include "sandbox/policy/linux/bpf_service_policy_linux.h"
 #include "sandbox/policy/linux/bpf_speech_recognition_policy_linux.h"
 #include "sandbox/policy/linux/bpf_utility_policy_linux.h"
+#include "third_party/blink/public/common/switches.h"
 
 #if BUILDFLAG(ENABLE_SCREEN_AI_SERVICE)
 #include "sandbox/policy/linux/bpf_screen_ai_policy_linux.h"
@@ -172,8 +175,26 @@ std::unique_ptr<BPFBasePolicy> SandboxSeccompBPF::PolicyForSandboxType(
   switch (sandbox_type) {
     case sandbox::mojom::Sandbox::kGpu:
       return GetGpuProcessSandbox(options.use_amd_specific_policies);
-    case sandbox::mojom::Sandbox::kRenderer:
-      return std::make_unique<RendererProcessPolicy>();
+    case sandbox::mojom::Sandbox::kRenderer: {
+      const base::CommandLine& command_line =
+          *base::CommandLine::ForCurrentProcess();
+      bool dynamic_code_can_be_disabled = false;
+      if (command_line.HasSwitch(blink::switches::kJavaScriptFlags)) {
+        std::string js_flags =
+            command_line.GetSwitchValueASCII(blink::switches::kJavaScriptFlags);
+        std::vector<base::StringPiece> js_flag_list = base::SplitStringPiece(
+            js_flags, ",", base::TRIM_WHITESPACE, base::SPLIT_WANT_NONEMPTY);
+        for (const auto& js_flag : js_flag_list) {
+          if (js_flag == "--jitless") {
+            // If v8 is running jitless then there is no need for the ability to
+            // mark writable pages as executable to be available to the process.
+            dynamic_code_can_be_disabled = true;
+            break;
+          }
+        }
+      }
+      return std::make_unique<RendererProcessPolicy>(dynamic_code_can_be_disabled);
+    }
 #if BUILDFLAG(ENABLE_PPAPI)
     case sandbox::mojom::Sandbox::kPpapi:
       return std::make_unique<PpapiProcessPolicy>();
@@ -193,9 +214,27 @@ std::unique_ptr<BPFBasePolicy> SandboxSeccompBPF::PolicyForSandboxType(
     case sandbox::mojom::Sandbox::kAudio:
       return std::make_unique<AudioProcessPolicy>();
     case sandbox::mojom::Sandbox::kService:
-      return std::make_unique<ServiceProcessPolicy>();
-    case sandbox::mojom::Sandbox::kServiceWithJit:
-      return std::make_unique<ServiceProcessPolicy>();
+      return std::make_unique<ServiceProcessPolicy>(true);
+    case sandbox::mojom::Sandbox::kServiceWithJit: {
+      const base::CommandLine& command_line =
+          *base::CommandLine::ForCurrentProcess();
+      bool dynamic_code_can_be_disabled = false;
+      if (command_line.HasSwitch(blink::switches::kJavaScriptFlags)) {
+        std::string js_flags =
+            command_line.GetSwitchValueASCII(blink::switches::kJavaScriptFlags);
+        std::vector<base::StringPiece> js_flag_list = base::SplitStringPiece(
+            js_flags, ",", base::TRIM_WHITESPACE, base::SPLIT_WANT_NONEMPTY);
+        for (const auto& js_flag : js_flag_list) {
+          if (js_flag == "--jitless") {
+            // If v8 is running jitless then there is no need for the ability to
+            // mark writable pages as executable to be available to the process.
+            dynamic_code_can_be_disabled = true;
+            break;
+          }
+        }
+      }
+      return std::make_unique<ServiceProcessPolicy>(dynamic_code_can_be_disabled);
+    }
     case sandbox::mojom::Sandbox::kSpeechRecognition:
       return std::make_unique<SpeechRecognitionProcessPolicy>();
 #if BUILDFLAG(ENABLE_SCREEN_AI_SERVICE)
